{
  "value": [
    {
      "id": "/subscriptions/1fake145-d7fa-4d0f-b406-7394a2b64fb4/resourceGroups/Api-Default-West-Europe/providers/Microsoft.ApiManagement/service/apidev/apis/invoice-retrieval-api/operations/get-invoice/policies/policy",
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "name": "policy",
      "properties": {
        "policyContent": "<policies>\r\n  <inbound>\r\n    <base />\r\n    <set-variable name=\"MARKET\" value=\"@(context.Request.MatchedParameters[&quot;marketId&quot;])\" />\r\n    <set-variable name=\"INVOICEID\" value=\"@(context.Request.MatchedParameters[&quot;invoiceId&quot;])\" />\r\n    <set-variable name=\"subkey\" value=\"@(context.Subscription.PrimaryKey)\" />\r\n    <choose>\r\n      <when condition=\"@(context.Variables.GetValueOrDefault&lt;string&gt;(&quot;MARKET&quot;) == &quot;DE&quot;)\">\r\n        <send-request mode=\"new\" response-variable-name=\"bridgetecResponse\" timeout=\"30\" ignore-error=\"false\">\r\n          <set-url>@{\r\n                        var baseUrl = \"https://apidev.azure-api.net\";\r\n                        var url = baseUrl +\"/api/documents/invoices/bridgetec/v1/invoice/\" + context.Variables.GetValueOrDefault&lt;string&gt;(\"INVOICEID\");\r\n                        return url;\r\n                    }</set-url>\r\n          <set-method>GET</set-method>\r\n          <set-header name=\"Ocp-Apim-Subscription-Key\" exists-action=\"override\">\r\n            <value>@(context.Variables.GetValueOrDefault&lt;string&gt;(\"subkey\"))</value>\r\n          </set-header>\r\n        </send-request>\r\n        <choose>\r\n          <when condition=\"@( ((IResponse)context.Variables[&quot;bridgetecResponse&quot;]).StatusCode &lt; 400)\">\r\n            <set-backend-service base-url=\"https://i-dev.azurewebsites.net/api/Base64ToStream\" />\r\n            <rewrite-uri template=\"?code={{int0001functionkey}}\" copy-unmatched-params=\"false\" />\r\n            <set-method>POST</set-method>\r\n            <set-header name=\"Content-Type\" exists-action=\"override\">\r\n              <value>text/plain</value>\r\n            </set-header>\r\n            <set-body template=\"none\">@(((IResponse)context.Variables[\"bridgetecResponse\"]).Body.As&lt;string&gt;())</set-body>\r\n          </when>\r\n          <otherwise>\r\n            <return-response>\r\n              <set-status code=\"@( ((IResponse)context.Variables[&quot;bridgetecResponse&quot;]).StatusCode )\" reason=\"@(((IResponse)context.Variables[&quot;bridgetecResponse&quot;]).StatusReason)\" />\r\n              <set-header name=\"Content-Type\" exists-action=\"override\">\r\n                <value>application/json</value>\r\n              </set-header>\r\n              <set-body>@{\r\n                                return ((IResponse)context.Variables[\"bridgetecResponse\"]).Body.As&lt;string&gt;();\r\n                            }</set-body>\r\n            </return-response>\r\n          </otherwise>\r\n        </choose>\r\n      </when>\r\n      <otherwise>\r\n        <rewrite-uri template=\"/360/invoice/getinvoice?company={marketId}&amp;invoice={invoiceId}\" />\r\n      </otherwise>\r\n    </choose>\r\n  </inbound>\r\n  <backend>\r\n    <base />\r\n  </backend>\r\n  <outbound>\r\n    <base />\r\n    <choose>\r\n      <when condition=\"@(context.Variables.GetValueOrDefault&lt;string&gt;(&quot;MARKET&quot;) == &quot;DE&quot; &amp;&amp; context.Response.StatusCode &lt; 400)\">\r\n        <set-header name=\"Content-Disposition\" exists-action=\"override\">\r\n          <value>@{\r\n                        var defaultValue = \"attachment; filename=\" + context.Variables.GetValueOrDefault&lt;string&gt;(\"MARKET\") + \"_\" + context.Variables.GetValueOrDefault&lt;string&gt;(\"INVOICEID\") + \".pdf\";\r\n                        return ((IResponse)context.Variables[\"bridgetecResponse\"]).Headers.GetValueOrDefault(\"Content-Disposition\", defaultValue);\r\n                    }</value>\r\n        </set-header>\r\n        <set-header name=\"Content-Type\" exists-action=\"override\">\r\n          <value>application/pdf</value>\r\n        </set-header>\r\n      </when>\r\n      <when condition=\"@(context.Response.StatusCode &lt; 400 &amp;&amp; context.Response.StatusCode != 204)\">\r\n        <set-header name=\"Content-Type\" exists-action=\"override\">\r\n          <value>application/pdf</value>\r\n        </set-header>\r\n      </when>\r\n      <when condition=\"@(context.Response.StatusCode &gt; 399 &amp;&amp; context.Variables.GetValueOrDefault&lt;string&gt;(&quot;MARKET&quot;) != &quot;DE&quot;)\">\r\n        <set-body template=\"none\">@{\r\n                    var response = context.Response.Body.As&lt;string&gt;(); \r\n                    return \"{ 'error' : { 'title' : 'Error communicating with 360', 'code' : '\"+ context.Response.StatusCode +\"', 'detail' : '\"+ response +\"', 'status' : '\"+ context.Response.StatusCode +\"'}}\";\r\n                }</set-body>\r\n      </when>\r\n    </choose>\r\n  </outbound>\r\n  <on-error>\r\n    <base />\r\n  </on-error>\r\n</policies>"
      }
    }
  ],
  "nextLink": ""
}